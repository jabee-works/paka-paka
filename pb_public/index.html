<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V30SN5HZ0B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-V30SN5HZ0B');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>paka-paka - „É™„Ç¢„É´„Çø„Ç§„É†„ÉÅ„É£„ÉÉ„Éà</title>

    <!-- PWA / Icons -->
    <link rel="icon" href="./icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FA6C9A">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: 'var(--theme-color)',
                        bg: {
                            main: 'var(--bg-main)',
                            panel: 'var(--bg-panel)',
                            input: 'var(--bg-input)',
                        },
                        text: {
                            main: 'var(--text-main)',
                            sub: 'var(--text-sub)',
                        },
                        border: {
                            main: 'var(--border-main)',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'toast-in': 'toastIn 0.3s ease-out',
                        'toast-out': 'toastOut 0.3s ease-in forwards',
                        'slide-in-new-message': 'slideInNewMessage 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        toastIn: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        toastOut: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(-100%)', opacity: '0' },
                        },
                        slideInNewMessage: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Pocketbase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --theme-color: #FA6C9A;
            --bg-main: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --border-main: #374151;
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] {
            --bg-main: #f3f4f6;
            --bg-panel: #ffffff;
            --bg-input: #e5e7eb;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border-main: #e5e7eb;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.05);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .h-dvh-fix {
            height: 100vh;
            height: 100dvh;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
            height: 100dvh;
        }

        #root {
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        input,
        textarea,
        button {
            font-size: 16px !important;
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--glass-border);
            transition: background 0.3s, border-color 0.3s;
        }

        .reaction-picker {
            z-index: 1000 !important;
            position: fixed;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
        }
    </script>

    <script type="text/babel">
        // ==========================================
        // „ÄêË®≠ÂÆö„ÄëFirebase Config
        // ==========================================
        // ‰∏ãË®ò„ÅÆÂÄ§„ÇíFirebase„Ç≥„É≥„ÇΩ„Éº„É´„Åã„ÇâÂèñÂæó„Åó„Å¶ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyB_tiPU9B2FgpJMaP5zvPfGsxHaIgk9Pbg",
            authDomain: "paka-paka-32ebd.firebaseapp.com",
            databaseURL: "https://paka-paka-32ebd-default-rtdb.firebaseio.com",
            projectId: "paka-paka-32ebd",
            storageBucket: "paka-paka-32ebd.firebasestorage.app",
            messagingSenderId: "289050189836",
            appId: "1:289050189836:web:fd2810ae03b3ada06bce29",
            measurementId: "G-618QVCQ7H8"
        };

        // Initialize Firebase
        let isFirebaseInitialized = false;
        try {
            if (FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(FIREBASE_CONFIG);
                isFirebaseInitialized = true;
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const { useState, useEffect, useRef, createContext, useContext, useCallback } = React;

        // --- Constants ---
        const REACTION_EMOJIS = ["üëç", "‚ù§Ô∏è", "üòÇ", "üòÆ", "üôè"];
        // „É¶„Éº„Ç∂„Éº„Ç¢„Ç§„Ç≥„É≥Áî®„Éó„É™„Çª„ÉÉ„ÉàÔºàÁµµÊñáÂ≠ó10Á®ÆÔºâ
        const ICON_PRESETS = ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ"];

        const HEARTBEAT_INTERVAL_MS = 20 * 1000;
        const GHOST_TIMEOUT_MS = 60 * 1000;

        const CHINCHIRO_BOT_PROFILE = {
            id: "bot_chinchiro",
            name: "„ÉÅ„É≥„ÉÅ„É≠BOT üé≤",
            color: "#FFA500",
            icon: "ü§ñ",
            bio: "„Çµ„Ç§„Ç≥„É≠„ÇíÊåØ„Çä„Åæ„ÅôÔºÅ„Äå„ÉÅ„É≥„ÉÅ„É≠„Äç„Å®ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        };

        // --- iOS/Native Notification Helper ---
        const sendNativeNotification = async (title, body) => {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification(title, { body, icon: './icon.svg' });
            }
        };

        // --- Utils ---
        // ÁîªÂÉèURLÂèñÂæó„É≠„Ç∏„ÉÉ„ÇØÂâäÈô§ÔºàÁµµÊñáÂ≠ó„ÅÆ„Åø‰ΩøÁî®„Åô„Çã„Åü„ÇÅÔºâ

        const renderTextWithLinks = (text) => {
            if (!text) return null;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);
            return parts.map((part, index) => {
                if (part.match(urlRegex)) {
                    const linkColorClass = 'text-cyan-400 font-bold hover:text-cyan-300 transition-colors';
                    return (
                        <a key={index} href={part} target="_blank" rel="noopener noreferrer" className={`underline break-all ${linkColorClass}`} onClick={e => e.stopPropagation()}>
                            {part}
                        </a>
                    );
                }
                return part;
            });
        };

        // --- Icons ---
        const LucideIcons = {
            ArrowLeft: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>,
            Send: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></svg>,
            Image: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></svg>,
            Users: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            MessageSquare: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>,
            Camera: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></svg>,
            Edit: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></svg>,
            LayoutGrid: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></svg>,
            Mic: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" x2="12" y1="19" y2="22" /></svg>,
            Film: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18" /><path d="M3 7.5h4" /><path d="M3 12h18" /><path d="M3 16.5h4" /><path d="M17 3v18" /><path d="M17 7.5h4" /><path d="M17 16.5h4" /></svg>,
            BookOpen: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></svg>,
            Sun: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></svg>,
            Moon: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>,
            AlertTriangle: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-9-15-9 15z" /><path d="M12 9v4" /><path d="M12 17h.01" /></svg>,
            CheckCircle: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><path d="m9 11 3 3L22 4" /></svg>,
            Info: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>,
            FileText: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M10 9H8" /><path d="M16 13H8" /><path d="M16 17H8" /></svg>,
            Gamepad2: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="6" x2="10" y1="12" y2="12" /><line x1="8" x2="8" y1="10" y2="14" /><line x1="15" x2="15.01" y1="13" y2="13" /><line x1="18" x2="18.01" y1="11" y2="11" /><rect width="20" height="12" x="2" y="6" rx="2" /></svg>,
            Tv: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="15" x="2" y="7" rx="2" ry="2" /><polyline points="17 2 12 7 7 2" /></svg>,
            Puzzle: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19.439 15.435a4.5 4.5 0 0 0-6.87-6.87 4.5 4.5 0 0 0-4.39-2.316 4.5 4.5 0 0 0 2.31 8.583 4.5 4.5 0 0 0 8.95.603Z" /></svg>,
            Mail: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></svg>,
            Trash2: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>,
            AlertOctagon: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>,
            ShieldAlert: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>,
            Bell: (props) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>,
        };

        const ROOM_ICONS = {
            'game': LucideIcons.Gamepad2,
            'anime': LucideIcons.Tv,
            'voice': LucideIcons.Mic,
            'movie': LucideIcons.Film,
            'comic': LucideIcons.BookOpen,
            'boardgame': LucideIcons.Puzzle,
        };

        const ROOMS = [
            { id: 'game', name: '„Ç≤„Éº„É†', desc: 'Êñ∞‰Ωú„Åã„Çâ„É¨„Éà„É≠„Åæ„Åß' },
            { id: 'boardgame', name: '„Éú„Éº„Éâ„Ç≤„Éº„É†', desc: '„Ç¢„Éä„É≠„Ç∞„Ç≤„Éº„É†ÂÖ®Ëà¨' },
            { id: 'anime', name: '„Ç¢„Éã„É°', desc: '‰ªäÊúü„ÅÆ„Ç¢„Éã„É°„Å´„Å§„ÅÑ„Å¶' },
            { id: 'voice', name: 'Â£∞ÂÑ™', desc: 'Êé®„Åó„ÅÆË©±„Çí„Åó„Çà„ÅÜ' },
            { id: 'movie', name: 'Êò†Áîª', desc: 'Êñ∞‰Ωú„ÉªÊóß‰Ωú„ÉªBÁ¥öÊò†Áîª' },
            { id: 'comic', name: 'Êº´Áîª', desc: '„Åä„Åô„Åô„ÇÅ„ÅÆÊº´Áîª„ÇíÁ¥π‰ªã' },
        ];

        // --- Context & Components ---
        const ToastContext = createContext();
        const useToast = () => useContext(ToastContext);

        const Toast = ({ message, type, onClose }) => {
            let bgColor = 'bg-gray-800';
            let icon = <LucideIcons.Info size={18} className="text-white" />;
            if (type === 'success') { bgColor = 'bg-green-500'; icon = <LucideIcons.CheckCircle size={18} className="text-white" />; }
            else if (type === 'error') { bgColor = 'bg-red-600'; icon = <LucideIcons.AlertTriangle size={18} className="text-white" />; }
            else if (type === 'info') { bgColor = 'bg-blue-500'; icon = <LucideIcons.Info size={18} className="text-white" />; }

            const [isVisible, setIsVisible] = useState(true);
            const [animationClass, setAnimationClass] = useState('animate-toast-in');

            const handleClose = () => {
                setAnimationClass('animate-toast-out');
                setTimeout(() => { setIsVisible(false); onClose(); }, 300);
            };

            useEffect(() => { const timer = setTimeout(handleClose, 3000); return () => clearTimeout(timer); }, []);

            if (!isVisible) return null;

            return (
                <div className={`fixed top-14 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-2xl z-[200] flex items-center gap-3 text-white max-w-sm w-[90%] transition-all ${bgColor} ${animationClass}`} onClick={handleClose}>
                    {icon} <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            const showToast = (message, type = 'info') => { setToast({ message, type, id: Date.now() }); };
            const closeToast = () => { setToast(null); };
            return (
                <ToastContext.Provider value={showToast}>
                    {children}
                    {toast && <Toast key={toast.id} message={toast.message} type={toast.type} onClose={closeToast} />}
                </ToastContext.Provider>
            );
        };

        const TermsModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center sm:justify-center p-4 animate-fade-in h-dvh-fix" onClick={onClose}>
                    <div className="bg-bg-panel w-full max-w-lg rounded-3xl overflow-hidden max-h-[90%] flex flex-col border border-border-main shadow-2xl animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="p-5 border-b border-border-main flex justify-between items-center bg-bg-input">
                            <h3 className="font-bold text-text-main flex items-center gap-2">Âà©Áî®Ë¶èÁ¥Ñ„Éª„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</h3>
                            <button onClick={onClose} className="p-2 -mr-2 text-text-sub hover:text-text-main text-xl">‚úï</button>
                        </div>
                        <div className="overflow-y-auto p-5 space-y-6 text-sm text-text-sub">
                            <section>
                                <h4 className="font-bold text-text-main mb-2">„Çµ„Éº„Éì„Çπ„Å´„Å§„ÅÑ„Å¶</h4>
                                <p>paka-paka„ÅØ„ÄÅË™∞„Åß„ÇÇÊ∞óËªΩ„Å´ÂèÇÂä†„Åß„Åç„Çã„ÉÅ„É£„ÉÉ„Éà„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„Åß„Åô„ÄÇÊú¨„Çµ„Éº„Éì„Çπ„ÅØ„Ç¢„Ç´„Ç¶„É≥„ÉàÁôªÈå≤„Å™„Åó„Åß„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„Åå„ÄÅÊäïÁ®øÂÜÖÂÆπ„ÅØ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Å´„ÇÇÂÖ¨Èñã„Åï„Çå„Åæ„Åô„ÅÆ„Åß„ÄÅÂÄã‰∫∫ÊÉÖÂ†±„ÅÆÊõ∏„ÅçËæº„Åø„Å´„ÅØÂçÅÂàÜ„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇËâØË≠ò„ÅÇ„ÇãÂà©Áî®„Çí„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ</p>
                            </section>
                            <div className="text-right mt-5">
                                <button onClick={onClose} className="py-2 px-4 bg-theme text-white rounded-lg font-bold hover:brightness-110 transition-all">Èñâ„Åò„Çã</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. Connection Screen (Now just Start Screen)
        const SetupScreen = ({ onConnect }) => {
            const [error, setError] = useState('');
            const showToast = useToast();

            const handleStart = async (e) => {
                e.preventDefault();
                setError('');

                if (!isFirebaseInitialized) {
                    setError('FirebaseË®≠ÂÆö„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇsource code„ÅÆFIREBASE_CONFIG„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                onConnect();
            };

            return (
                <div className="flex flex-col items-center justify-center p-6 bg-bg-main relative overflow-hidden h-dvh-fix">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-theme to-purple-500"></div>
                    <div className="w-full max-w-md space-y-8 relative z-10 animate-slide-up">
                        <div className="text-center">
                            <h1 className="text-5xl font-bold tracking-tight text-theme mb-2 drop-shadow-[0_0_10px_rgba(var(--theme-color),0.3)]">paka-paka</h1>
                            <p className="text-text-sub text-sm tracking-widest uppercase">Realtime Chat</p>
                        </div>
                        <div className="bg-bg-panel/80 backdrop-blur-md p-8 rounded-2xl border border-border-main shadow-2xl">
                            <form onSubmit={handleStart} className="space-y-6">
                                {error && <p className="text-red-500 text-sm font-bold text-center bg-red-900/20 p-2 rounded">{error}</p>}
                                <div className="text-center text-text-sub text-sm mb-4">
                                    „Ç¢„Ç´„Ç¶„É≥„ÉàÁôªÈå≤‰∏çË¶Å„Åß<br />„Åô„Åê„Å´Âßã„ÇÅ„Çâ„Çå„Åæ„Åô
                                </div>
                                <button type="submit" className="w-full py-4 px-4 font-bold rounded-xl text-white bg-theme hover:brightness-110 transition-all shadow-[0_0_15px_rgba(var(--theme-color),0.5)]">
                                    START
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Profile Setup
        const ProfileSetup = ({ profile, onSave, onCancel }) => {
            const [name, setName] = useState((profile && profile.name) || '');
            const [bio, setBio] = useState((profile && profile.bio) || '');
            const [color, setColor] = useState((profile && profile.color) || '#FA6C9A');
            const [icon, setIcon] = useState((profile && profile.icon) || ICON_PRESETS[0]);
            const [themeMode, setThemeMode] = useState(localStorage.getItem('theme_mode') || 'dark');
            const showToast = useToast();
            const colors = ['#FA6C9A', '#00ffff', '#bd00ff', '#fbbf24', '#ef4444', '#10b981'];

            useEffect(() => {
                document.documentElement.style.setProperty('--theme-color', color);
            }, [color]);

            useEffect(() => {
                if (themeMode === 'light') {
                    document.documentElement.setAttribute('data-theme', 'light');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }, [themeMode]);

            const [notificationEnabled, setNotificationEnabled] = useState(localStorage.getItem('notification_enabled') === 'true');

            const handleNotificationToggle = () => {
                if (!notificationEnabled) {
                    if (Notification.permission === 'granted') {
                        setNotificationEnabled(true);
                        showToast('ÈÄöÁü•„Çí„Ç™„É≥„Å´„Åó„Åæ„Åó„Åü', 'success');
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                setNotificationEnabled(true);
                                showToast('ÈÄöÁü•„Çí„Ç™„É≥„Å´„Åó„Åæ„Åó„Åü', 'success');
                            } else {
                                showToast('ÈÄöÁü•„ÅåË®±ÂèØ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü', 'error');
                            }
                        });
                    } else {
                        showToast('„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÅßÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    }
                } else {
                    setNotificationEnabled(false);
                    showToast('ÈÄöÁü•„Çí„Ç™„Éï„Å´„Åó„Åæ„Åó„Åü', 'info');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                localStorage.setItem('theme_mode', themeMode);

                onSave({
                    id: (profile && profile.id) || 'u_' + Math.random().toString(36).substr(2, 9),
                    name: name || 'ÂêçÁÑ°„Åó',
                    bio,
                    color,
                    icon, // Just the emoji string
                });
                localStorage.setItem('notification_enabled', notificationEnabled);
                showToast('„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            };

            return (
                <div className="absolute inset-0 z-50 bg-bg-main flex flex-col p-6 animate-fade-in overflow-y-auto h-dvh-fix">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-xl font-bold text-text-main">„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö</h2>
                        {onCancel && (
                            <button onClick={onCancel} className="p-2 -mr-2 text-text-sub hover:text-text-main text-xl">‚úï</button>
                        )}
                    </div>
                    <form onSubmit={handleSubmit} className="flex-1 flex flex-col space-y-8 max-w-md mx-auto w-full pb-20">

                        {/* Icon Selection */}
                        <div>
                            <label className="text-xs font-bold text-text-sub uppercase ml-1 mb-2 block">„Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû</label>
                            <div className="flex justify-center mb-6">
                                <div className="w-24 h-24 rounded-full flex items-center justify-center text-6xl border-4 border-theme shadow-lg bg-bg-panel transition-all duration-300">
                                    <span style={{ color: color }}>{icon}</span>
                                </div>
                            </div>
                            <div className="grid grid-cols-5 gap-3 p-2 bg-bg-input rounded-xl border border-border-main">
                                {ICON_PRESETS.map((emoji) => (
                                    <button
                                        key={emoji}
                                        type="button"
                                        onClick={() => setIcon(emoji)}
                                        className={`aspect-square flex items-center justify-center text-2xl rounded-lg transition-all hover:bg-bg-panel ${icon === emoji ? 'bg-bg-panel shadow-md scale-110' : ''}`}
                                    >
                                        {emoji}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="text-xs font-bold text-text-sub uppercase ml-1">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-bg-input p-4 rounded-xl mt-2 text-text-main border border-border-main focus:border-theme focus:bg-bg-input outline-none transition-all" placeholder="„Éè„É≥„Éâ„É´„Éç„Éº„É†" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-text-sub uppercase ml-1">„ÉÜ„Éº„Éû„Ç´„É©„Éº</label>
                                <div className="flex gap-4 overflow-x-auto py-3 px-1 no-scrollbar">
                                    {colors.map(c => (
                                        <button key={c} type="button" onClick={() => setColor(c)} className={`w-12 h-12 rounded-full border-2 flex-shrink-0 transition-transform ${color === c ? 'border-text-main scale-110 shadow-lg' : 'border-transparent opacity-50 hover:opacity-100'}`} style={{ backgroundColor: c }} />
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-text-sub uppercase ml-1">Â§ñË¶≥„É¢„Éº„Éâ</label>
                                <div className="flex mt-2 bg-bg-input rounded-xl p-1 border border-border-main">
                                    <button type="button" onClick={() => setThemeMode('dark')} className={`flex-1 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-bold transition-all ${themeMode === 'dark' ? 'bg-bg-panel text-theme shadow-sm' : 'text-text-sub'}`}><LucideIcons.Moon size={16} /> „ÉÄ„Éº„ÇØ</button>
                                    <button type="button" onClick={() => setThemeMode('light')} className={`flex-1 py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-bold transition-all ${themeMode === 'light' ? 'bg-bg-panel text-theme shadow-sm' : 'text-text-sub'}`}><LucideIcons.Sun size={16} /> „É©„Ç§„Éà</button>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-text-sub uppercase ml-1">ÈÄöÁü•Ë®≠ÂÆö</label>
                                <button type="button" onClick={handleNotificationToggle} className={`w-full py-3 mt-2 rounded-xl flex items-center justify-between px-4 font-bold border ${notificationEnabled ? 'bg-bg-panel border-theme text-theme' : 'bg-bg-input border-border-main text-text-sub'}`}>
                                    <span className="flex items-center gap-2"><LucideIcons.Bell size={18} /> ÈÄöÁü• {notificationEnabled ? 'ON' : 'OFF'}</span>
                                    <div className={`w-10 h-6 rounded-full relative transition-colors ${notificationEnabled ? 'bg-theme' : 'bg-gray-500'}`}>
                                        <div className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${notificationEnabled ? 'left-5' : 'left-1'}`}></div>
                                    </div>
                                </button>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-text-sub uppercase ml-1">Ëá™Â∑±Á¥π‰ªã</label>
                                <textarea value={bio} onChange={(e) => setBio(e.target.value)} className="w-full bg-bg-input p-4 rounded-xl mt-2 text-text-main border border-border-main focus:border-theme focus:bg-bg-input outline-none transition-all" rows="3" placeholder="Ëá™Â∑±Á¥π‰ªãÊñá" />
                            </div>
                        </div>

                        <div className="mt-8">
                            <button type="submit" className="w-full py-4 bg-theme text-white font-bold text-lg rounded-xl shadow-lg shadow-theme/30 hover:brightness-110 transition-all">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
                        </div>
                    </form>
                </div>
            );
        };

        // 3. User Profile Modal
        const UserProfileModal = ({ user, onClose }) => {
            const userName = user.name || user.user_name;
            const userIcon = user.icon || user.user_icon;
            const userColor = user.color || user.user_color;
            const userBio = user.bio || user.user_bio;

            return (
                <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center animate-fade-in" onClick={onClose}>
                    <div className="bg-bg-panel w-full max-w-xs rounded-3xl p-6 border border-border-main shadow-2xl animate-slide-up" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex flex-col items-center w-full">
                                <div className="w-20 h-20 rounded-full flex items-center justify-center text-4xl border-4 border-theme shadow-lg shadow-theme/30 overflow-hidden bg-bg-main" style={{ borderColor: userColor }}>
                                    <span style={{ color: userColor }}>{userIcon || userName.charAt(0)}</span>
                                </div>
                                <h3 className="text-xl font-bold text-text-main mt-3">{userName}</h3>
                            </div>
                            <button onClick={onClose} className="p-2 -mr-4 text-text-sub hover:text-text-main text-xl">‚úï</button>
                        </div>
                        <div className="text-sm bg-bg-main p-4 rounded-xl border border-border-main">
                            <p className="text-text-sub text-xs mb-2 uppercase font-bold">Ëá™Â∑±Á¥π‰ªã</p>
                            <p className="text-text-main whitespace-pre-wrap">{userBio || 'Ëá™Â∑±Á¥π‰ªãÊñá„ÅØË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ'}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Reaction Picker
        const ReactionPicker = ({ message, onReact, onClose, position }) => {
            const pickerRef = useRef(null);
            const style = { top: position.y, left: position.x, transform: 'translate(-50%, -100%) translateY(-10px)' };
            const handleEmojiClick = (emoji) => { onReact(message, emoji); onClose(); };
            return (
                <div className="reaction-picker fixed p-2 bg-bg-panel/95 backdrop-blur-md rounded-full shadow-2xl border border-border-main animate-fade-in" style={style} ref={pickerRef} onClick={e => e.stopPropagation()}>
                    <div className="flex space-x-2">
                        {REACTION_EMOJIS.map(emoji => (
                            <button key={emoji} onClick={() => handleEmojiClick(emoji)} className="text-2xl hover:scale-125 transition-transform duration-150 p-1">{emoji}</button>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. Chat Room
        const ChatRoom = ({ room, profile, onBack, onOpenProfile, isEmbedded = false }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [sending, setSending] = useState(false);
            const [members, setMembers] = useState([]);
            const [showMembers, setShowMembers] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [targetMessage, setTargetMessage] = useState(null);
            const [pickerPosition, setPickerPosition] = useState({ x: 0, y: 0 });
            const showToast = useToast();
            const scrollRef = useRef(null);

            // Join Room (Presence)
            useEffect(() => {
                if (!profile) return;
                const rtdb = firebase.database();
                const memberRef = rtdb.ref(`rooms/${room.id}/members/${profile.id}`);

                const presenceData = {
                    user_id: profile.id,
                    user_name: profile.name,
                    user_color: profile.color,
                    user_icon: profile.icon,
                    user_bio: profile.bio || "",
                    last_seen: firebase.database.ServerValue.TIMESTAMP
                };

                // Set presence
                memberRef.set(presenceData);
                // Remove on disconnect
                memberRef.onDisconnect().remove();

                return () => {
                    memberRef.remove();
                };
            }, [room.id, profile]);

            // Listen for Messages
            useEffect(() => {
                setMessages([]);
                const rtdb = firebase.database();
                const messagesRef = rtdb.ref(`rooms/${room.id}/messages`);
                const q = messagesRef.orderByChild('date').limitToLast(50);
                const isInitialLoad = { current: true };

                const handleMessage = (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setMessages(prev => {
                            if (prev.some(m => m.id === snapshot.key)) return prev;
                            const newMsg = { id: snapshot.key, ...data };

                            // Notification Logic
                            // Only notify if not initial load, not my message, and message is newer than mount time (approx)
                            // AND Notification is enabled in settings
                            if (!isInitialLoad.current && newMsg.user_id !== profile.id) {
                                if (localStorage.getItem('notification_enabled') === 'true') {
                                    sendNativeNotification(`New message from ${newMsg.user_name}`, newMsg.text);
                                }
                            }

                            return [...prev, newMsg].sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
                        });
                        if (isInitialLoad.current) {
                            setTimeout(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, 100);
                        }
                    }
                };

                // Allow notifications after a short delay
                setTimeout(() => { isInitialLoad.current = false; }, 2000);

                const handleChildAdded = (snapshot) => {
                    // We use on('value') for initial state but child_added explains the flow better. 
                    // Actually, current implementation uses on('value') in original code? 
                    // The original code below uses on('value'). Let's stick to on('child_added') mixed with value?
                    // No, original code used on('value') but that updates everything.
                    // Let's just hook into the existing state update logic.
                    // The existing code uses on('value')? Let's check below.
                    // Wait, the original code had:
                    // const handleMessage = (snapshot) => { const data = snapshot.val(); ... }
                    // messagesRef.orderByChild('date').limitToLast(50).on('child_added', handleMessage);
                    // Let's verify what event is used.
                };

                // Switching to child_added for better per-message control
                q.on('child_added', handleMessage);
                q.on('child_changed', (snapshot) => {
                    // Handle updates (reactions)
                    setMessages(prev => prev.map(m => m.id === snapshot.key ? { ...m, ...snapshot.val() } : m));
                });

                return () => {
                    q.off('child_added', handleMessage);
                    q.off('child_changed');
                };
            }, [room.id, profile.id]);


            // Listen for Members
            useEffect(() => {
                const rtdb = firebase.database();
                const membersRef = rtdb.ref(`rooms/${room.id}/members`);

                const handleMembers = (snapshot) => {
                    const data = snapshot.val();
                    if (!data) {
                        setMembers([]);
                        return;
                    }
                    const list = Object.values(data);
                    setMembers(list);
                };

                membersRef.on('value', handleMembers);
                return () => membersRef.off('value', handleMembers);
            }, [room.id]);


            const handleSend = async () => {
                if (!input.trim()) return;
                setSending(true);
                const text = input.trim();

                try {
                    const rtdb = firebase.database();
                    const messagesRef = rtdb.ref(`rooms/${room.id}/messages`);
                    await messagesRef.push({
                        text,
                        user_id: profile.id,
                        user_name: profile.name,
                        user_color: profile.color,
                        user_icon: profile.icon,
                        room: room.id,
                        date: new Date().toISOString()
                    });
                    setInput('');
                    setTimeout(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, 100);
                } catch (e) {
                    showToast("ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
                    console.error(e);
                } finally {
                    setSending(false);
                }
            };

            const handleReact = (msg, emoji) => {
                if (!msg) return;
                const reactionRef = firebase.database().ref(`rooms/${room.id}/messages/${msg.id}/reactions/${emoji}`);
                reactionRef.transaction((currentData) => {
                    if (currentData && currentData[profile.id]) {
                        const next = { ...currentData };
                        delete next[profile.id];
                        return next;
                    } else {
                        return { ...(currentData || {}), [profile.id]: true };
                    }
                });
                setTargetMessage(null);
            };

            // Formatting
            const formatMessageTime = (dateStr) => {
                if (!dateStr) return "";
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch (e) { return ""; }
            };

            const openReactionPicker = (e, msg) => {
                e.stopPropagation();
                if (msg.user_id === profile.id) { setTargetMessage(null); return; }
                const rect = e.currentTarget.getBoundingClientRect();
                setPickerPosition({ x: rect.left + rect.width / 2, y: rect.top });
                setTargetMessage(msg);
            };

            const handleUserClick = (u) => {
                setSelectedUser({
                    user_name: u.user_name,
                    user_icon: u.user_icon,
                    user_color: u.user_color,
                    user_bio: u.user_bio
                });
            }

            return (
                <div className={`bg-bg-main ${isEmbedded ? 'relative flex flex-col w-full h-full' : 'absolute inset-0 z-10 animate-fade-in h-dvh-fix'}`}>
                    <header className={`glass z-40 transition-all safe-top ${isEmbedded ? 'hidden' : 'fixed top-0 left-0 right-0'}`}>
                        <div className="h-16 flex items-center justify-between px-4">
                            <div className="flex items-center gap-2">
                                {!isEmbedded && (
                                    <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-white/10 text-theme transition-colors">
                                        <LucideIcons.ArrowLeft size={24} />
                                    </button>
                                )}
                                <h2 className="text-lg font-bold text-text-main tracking-tight flex items-center gap-2">
                                    <span className="text-2xl">{room.id === 'general' ? 'üí¨' : 'üé≤'}</span>
                                    {room.name}
                                </h2>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={() => setShowMembers(true)} className="p-2 rounded-full hover:bg-white/10 text-theme transition-colors relative">
                                    <LucideIcons.Users size={24} />
                                    <span className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full border border-bg-panel"></span>
                                </button>
                                <button onClick={onOpenProfile} className="relative group transition-transform active:scale-95 ml-2">
                                    <div className="w-8 h-8 rounded-full border-2 p-0.5 flex items-center justify-center overflow-hidden bg-bg-panel" style={{ borderColor: profile?.color || 'var(--theme-color)' }}>
                                        <span className="font-bold text-sm pt-0.5" style={{ color: profile?.color || 'var(--theme-color)' }}>{profile?.icon || (profile?.name ? profile.name[0] : '?')}</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </header>

                    {isEmbedded && (
                        <div className="p-4 flex justify-between items-center bg-bg-main/80 backdrop-blur-sm z-30 sticky top-0 border-b border-border-main">
                            <h2 className="font-bold text-sm text-text-sub uppercase tracking-widest flex items-center gap-2">
                                <LucideIcons.MessageSquare size={16} className="text-theme" /> {room.name}
                            </h2>
                            <button onClick={() => setShowMembers(true)} className="p-2 -mr-2 text-text-sub hover:text-theme transition-colors">
                                <LucideIcons.Users size={20} />
                            </button>
                        </div>
                    )}

                    {targetMessage && <ReactionPicker message={targetMessage} onReact={handleReact} onClose={() => setTargetMessage(null)} position={pickerPosition} />}

                    <div ref={scrollRef} className={`overflow-y-auto space-y-4 ${isEmbedded ? 'flex-1 p-4 pb-40' : 'absolute inset-0 p-4 pt-20 pb-40'} flex flex-col`}>
                        {messages.length === 0 && <div className="h-full flex items-center justify-center text-text-sub opacity-50">„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>}
                        {messages.map((msg, i) => {
                            const isMe = msg.user_id === profile.id;
                            const showAvatar = i === 0 || messages[i - 1].user_id !== msg.user_id;

                            let reactions = {};
                            if (msg.reactions) {
                                // msg.reactions = { "emoji": { "uid": true, "uid2": true }}
                                Object.keys(msg.reactions).forEach(emoji => {
                                    reactions[emoji] = Object.keys(msg.reactions[emoji]);
                                });
                            }
                            const reactionEntries = Object.entries(reactions).filter(([_, ids]) => ids.length > 0);

                            return (
                                <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in-new-message`}>
                                    {!isMe && (
                                        <div className="w-10 flex-shrink-0 mr-2 flex flex-col items-center">
                                            {showAvatar && (
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-2xl border border-border-main overflow-hidden bg-bg-panel cursor-pointer" style={{ borderColor: msg.user_color }} onClick={() => handleUserClick(msg)}>
                                                    <span style={{ color: msg.user_color }}>{msg.user_icon || (msg.user_name || '?')[0]}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className={`max-w-[75%]`}>
                                        {!isMe && showAvatar && <div className="text-xs text-text-sub mb-1 ml-1" style={{ color: msg.user_color }}>{msg.user_name}</div>}
                                        <div className={`px-4 py-3 text-sm shadow-md ${isMe ? 'bg-theme text-white font-medium rounded-2xl rounded-tr-sm' : 'bg-bg-panel text-text-main rounded-2xl rounded-tl-sm border border-border-main'}`} onClick={(e) => openReactionPicker(e, msg)}>
                                            <div className="whitespace-pre-wrap leading-relaxed">{renderTextWithLinks(msg.text)}</div>
                                        </div>
                                        {reactionEntries.length > 0 && (
                                            <div className={`mt-1 flex gap-1 ${isMe ? 'justify-end' : 'justify-start'}`}>
                                                {reactionEntries.map(([emoji, userIds]) => {
                                                    const reactedByMe = userIds.includes(profile.id);
                                                    return (
                                                        <button key={emoji} className={`text-xs px-2 py-0.5 rounded-full border shadow-sm transition-all duration-150 active:scale-[0.9] ${reactedByMe ? 'bg-theme text-white border-theme' : 'bg-bg-panel text-text-main border-border-main'}`} onClick={(e) => { e.stopPropagation(); handleReact(msg, emoji); }}>
                                                            {emoji} {userIds.length}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                        <div className="text-[10px] text-text-sub mt-1 text-right">
                                            {formatMessageTime(msg.date)}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className={`p-3 glass z-40 transition-all fixed left-0 right-0 ${isEmbedded ? 'bottom-16 border-t border-border-main' : 'bottom-0 safe-bottom'}`}>
                        <div className="flex items-end gap-3 max-w-4xl mx-auto">
                            <div className="flex-1 bg-bg-input rounded-2xl border border-border-main focus-within:border-theme flex items-center">
                                <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} placeholder={sending ? "..." : "„É°„ÉÉ„Çª„Éº„Ç∏..."} rows="1" disabled={sending} className="w-full bg-transparent text-text-main px-4 py-3 focus:outline-none resize-none" style={{ minHeight: '48px', maxHeight: '100px' }} />
                            </div>
                            <button onClick={handleSend} disabled={sending || !input.trim()} className={`p-3 rounded-xl shadow-lg ${input.trim() && !sending ? 'bg-theme text-white' : 'bg-gray-700 text-gray-500 cursor-not-allowed opacity-50'}`}><LucideIcons.Send size={22} /></button>
                        </div>
                    </div>

                    {
                        showMembers && (
                            <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center sm:justify-center p-4" onClick={() => setShowMembers(false)}>
                                <div className="bg-bg-panel w-full max-w-sm rounded-3xl overflow-hidden max-h-[70%] flex flex-col border border-border-main" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b border-border-main flex justify-between items-center bg-bg-input"><h3 className="font-bold">ÂèÇÂä†„É°„É≥„Éê„Éº</h3><button onClick={() => setShowMembers(false)}>‚úï</button></div>
                                    <div className="overflow-y-auto p-2">
                                        {members.map(m => (
                                            <div key={m.user_id} className="flex items-center p-3 hover:bg-bg-input rounded-xl cursor-pointer" onClick={() => { setShowMembers(false); handleUserClick(m); }}>
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-xl border border-border-main overflow-hidden bg-bg-panel" style={{ borderColor: m.user_color }}>
                                                    <span style={{ color: m.user_color }}>{m.user_icon || (m.user_name || '?')[0]}</span>
                                                </div>
                                                <div className="ml-3">
                                                    <div className="font-bold text-sm">{m.user_name}</div>
                                                    <div className="text-xs text-text-sub truncate">{m.user_bio || ''}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {selectedUser && <UserProfileModal user={selectedUser} onClose={() => setSelectedUser(null)} />}
                </div>
            );
        };

        // 5. Lobby
        const Lobby = ({ onChangeRoom, onOpenProfile, profile, currentTab, onTabChange }) => {
            const [roomStats, setRoomStats] = useState({});
            const [showTermsModal, setShowTermsModal] = useState(false);

            useEffect(() => {
                const rtdb = firebase.database();
                const roomsRef = rtdb.ref('rooms');

                const handleValue = (snapshot) => {
                    const data = snapshot.val();
                    if (!data) { setRoomStats({}); return; }

                    const newStats = {};
                    Object.keys(data).forEach(roomId => {
                        const roomData = data[roomId];
                        const members = roomData.members ? Object.values(roomData.members) : [];

                        // Active check (offline handling is done by onDisconnect, but we can also check last_seen if needed)
                        // For now just count the members present in the DB, assuming onDisconnect works reliably
                        const activeMembers = members;

                        newStats[roomId] = {
                            count: activeMembers.length,
                            users: activeMembers.slice(0, 5)
                        };
                    });
                    setRoomStats(newStats);
                }

                roomsRef.on('value', handleValue);
                return () => roomsRef.off('value', handleValue);
            }, []);

            const handleEnterRoom = (room) => {
                const currentCount = (roomStats[room.id] && roomStats[room.id].count) || 0;
                if (currentCount >= 10) {
                    return;
                }
                onChangeRoom(room);
            };

            return (
                <div className="flex flex-col overflow-hidden animate-fade-in bg-bg-main relative h-dvh-fix">
                    <header className="bg-bg-main border-b border-border-main safe-top">
                        <div className="p-4 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <h1 className="text-2xl font-bold text-text-main tracking-wide">
                                    paka-paka
                                </h1>
                            </div>
                            <button onClick={onOpenProfile} className="relative group transition-transform active:scale-95">
                                <div className="w-10 h-10 rounded-full border-2 p-0.5 flex items-center justify-center overflow-hidden bg-bg-panel shadow-[0_0_10px_rgba(var(--theme-color),0.3)]" style={{ borderColor: profile?.color || 'var(--theme-color)' }}>
                                    <span className="font-bold text-2xl pt-1" style={{ color: profile?.color || 'var(--theme-color)' }}>{profile?.icon || (profile?.name ? profile.name[0] : '?')}</span>
                                </div>
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 flex flex-col overflow-hidden relative pb-16">
                        {currentTab === 'board' ? (
                            <ChatRoom room={{ id: 'general', name: '„Ç™„Éº„Éó„É≥Êé≤Á§∫Êùø' }} profile={profile} isEmbedded={true} onOpenProfile={onOpenProfile} />
                        ) : (
                            <div className="flex-1 overflow-y-auto p-4 animate-fade-in">
                                <div className="mb-4 text-center">
                                    <button
                                        onClick={() => setShowTermsModal(true)}
                                        className="inline-flex items-center gap-2 text-xs font-bold text-text-sub hover:text-theme transition-colors p-2 rounded-lg bg-bg-panel border border-border-main"
                                    >
                                        <LucideIcons.FileText size={16} />
                                        Âà©Áî®Ë¶èÁ¥Ñ„Éª„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº
                                    </button>
                                </div>

                                <div className="grid gap-4">
                                    {ROOMS.map(room => {
                                        const Icon = ROOM_ICONS[room.id] || Icons.MessageSquare;
                                        const stats = roomStats[room.id] || { count: 0, users: [] };
                                        return (
                                            <div key={room.id} onClick={() => handleEnterRoom(room)} className={`relative group cursor-pointer overflow-hidden rounded-2xl bg-bg-panel border border-border-main transition-all duration-300 active:scale-[0.98] ${stats.count >= 10 ? 'opacity-50' : 'hover:border-theme'}`}>
                                                <div className="absolute inset-0 bg-gradient-to-r from-theme to-transparent opacity-0 group-hover:opacity-5 transition-opacity"></div>
                                                <div className="p-5">
                                                    <div className="flex items-center space-x-4 mb-3">
                                                        <div className="p-3 rounded-xl bg-bg-input text-theme border border-border-main"><Icon size={24} /></div>
                                                        <div>
                                                            <h3 className="text-lg font-bold text-text-main group-hover:text-theme transition-colors">{room.name}</h3>
                                                            <p className="text-xs text-text-sub mt-1">{room.desc}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between items-end border-t border-border-main pt-3 mt-2">
                                                        <div className="flex -space-x-2">
                                                            {stats.users.map((u, idx) => {
                                                                return (
                                                                    <div key={idx} className="w-6 h-6 rounded-full border border-bg-main bg-bg-input flex items-center justify-center overflow-hidden text-[10px] font-bold relative z-10" style={{ borderColor: u.user_color }}>
                                                                        <span className="pt-0.5" style={{ color: u.user_color }}>{(u.user_icon || (u.user_name && u.user_name[0]) || '?')}</span>
                                                                    </div>
                                                                );
                                                            })}
                                                            {stats.count === 0 && <span className="text-xs text-text-sub">No users</span>}
                                                        </div>
                                                        <div className={`text-xs font-mono font-bold ${stats.count >= 10 ? 'text-red-500' : 'text-theme'}`}>
                                                            <span className="text-lg">{stats.count}</span>/10
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    <nav className="fixed bottom-0 left-0 right-0 bg-bg-main border-t border-border-main flex justify-around safe-bottom z-50 pt-2 pb-1">
                        <button onClick={() => onTabChange('board')} className={`flex flex-col items-center justify-center w-full py-1 transition-colors ${currentTab === 'board' ? 'text-theme' : 'text-text-sub hover:text-text-main'}`}>
                            <LucideIcons.MessageSquare size={24} /> <span className="text-[10px] mt-1 font-bold">Êé≤Á§∫Êùø</span>
                        </button>
                        <button onClick={() => onTabChange('rooms')} className={`flex flex-col items-center justify-center w-full py-1 transition-colors ${currentTab === 'rooms' ? 'text-theme' : 'text-text-sub hover:text-text-main'}`}>
                            <LucideIcons.LayoutGrid size={24} /> <span className="text-[10px] mt-1 font-bold">ÈÉ®Â±ã</span>
                        </button>
                    </nav>

                    {showTermsModal && <TermsModal onClose={() => setShowTermsModal(false)} />}
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [hasStarted, setHasStarted] = useState(false);
            const [profile, setProfile] = useState(null);
            const [currentRoom, setCurrentRoom] = useState(null);
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [lastLobbyTab, setLastLobbyTab] = useState('board');
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                const savedMode = localStorage.getItem('theme_mode');
                if (savedMode === 'light') document.documentElement.setAttribute('data-theme', 'light');

                const savedProfile = localStorage.getItem('chat_profile');
                if (savedProfile) {
                    const p = JSON.parse(savedProfile);
                    // Check if profile has valid required fields
                    if (p && p.name && p.icon) {
                        setProfile(p);
                        if (p.color) document.documentElement.style.setProperty('--theme-color', p.color);
                        setHasStarted(true);
                    } else {
                        // Profile incomplete, treat as new user
                        setProfile({ id: 'u_' + Math.random().toString(36).substr(2, 9), name: '', color: '#FA6C9A', bio: '', icon: ICON_PRESETS[0] });
                        setIsEditingProfile(true);
                    }
                } else {
                    // No profile found, initialize default and show editor
                    setProfile({ id: 'u_' + Math.random().toString(36).substr(2, 9), name: '', color: '#FA6C9A', bio: '', icon: ICON_PRESETS[0] });
                    setIsEditingProfile(true);
                }

                // Authentication Listener
                const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        setIsAuthReady(true);
                    } else {
                        firebase.auth().signInAnonymously().catch(console.error);
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleSaveProfile = async (newProfile) => {
                setProfile(newProfile);
                localStorage.setItem('chat_profile', JSON.stringify(newProfile));
                document.documentElement.style.setProperty('--theme-color', newProfile.color);
                setIsEditingProfile(false);
                setHasStarted(true); // Now we have started

                // Update presence if in a room
                if (currentRoom) {
                    const rtdb = firebase.database();
                    const updates = {};
                    updates[`rooms/${currentRoom.id}/members/${newProfile.id}`] = {
                        user_id: newProfile.id,
                        user_name: newProfile.name,
                        user_color: newProfile.color,
                        user_icon: newProfile.icon,
                        user_bio: newProfile.bio || "",
                        last_seen: firebase.database.ServerValue.TIMESTAMP
                    };
                    rtdb.ref().update(updates);
                }
            };

            const AppContent = () => {
                if (!isAuthReady) return <div className="h-dvh-fix bg-bg-main flex items-center justify-center text-theme font-bold tracking-widest animate-pulse">CONNECTING...</div>;

                // If not started (and auth ready), it means we are in initial profile setup flow
                // We show ProfileSetup directly.
                if (!hasStarted || isEditingProfile) {
                    return (
                        <ProfileSetup
                            profile={profile}
                            onSave={handleSaveProfile}
                            onCancel={hasStarted ? () => setIsEditingProfile(false) : null}
                        />
                    );
                }

                if (currentRoom) return <ChatRoom room={currentRoom} profile={profile} onBack={() => setCurrentRoom(null)} onOpenProfile={() => setIsEditingProfile(true)} />;
                return <Lobby onChangeRoom={setCurrentRoom} onOpenProfile={() => setIsEditingProfile(true)} profile={profile} currentTab={lastLobbyTab} onTabChange={setLastLobbyTab} />;
            };

            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>