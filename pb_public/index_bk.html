<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>paka-paka | ÂåøÂêçÈõëË´á„ÉÅ„É£„ÉÉ„Éà</title>

    <!-- ‚òÖ‰øÆÊ≠£: PocketBase„Çí„Åì„Åì„ÅßÁ¢∫ÂÆü„Å´Ë™≠„ÅøËæº„ÇÄ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- „Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö -->
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">

    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [v-cloak] {
            display: none;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .page-enter-active,
        .page-leave-active {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .page-enter-from {
            opacity: 0;
            transform: translateY(5px);
        }

        .page-leave-to {
            opacity: 0;
            transform: translateY(-5px);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .notification-enter-active,
        .notification-leave-active {
            transition: all 0.3s ease;
        }

        .notification-enter-from,
        .notification-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }

        .zoom-enter-active,
        .zoom-leave-active {
            transition: transform 0.2s, opacity 0.2s;
        }

        .zoom-enter-from,
        .zoom-leave-to {
            transform: scale(0.9);
            opacity: 0;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
</head>

<body
    class="bg-gray-100 md:bg-gray-200 text-gray-800 font-sans fixed inset-0 overflow-hidden flex flex-col md:items-center md:justify-center transition-colors duration-500">

    <div id="app" v-cloak
        class="w-full h-full bg-white relative flex flex-col md:flex-row md:max-w-5xl md:h-[90vh] md:rounded-2xl md:shadow-2xl md:overflow-hidden transition-all duration-300">

        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <aside class="hidden md:flex flex-col w-64 text-white flex-shrink-0 z-20 transition-colors duration-300"
            :class="theme.sidebar">
            <div class="p-6 font-bold text-xl tracking-wider flex items-center gap-2">
                <span>üê¥</span> paka-paka (PBÁâà)
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <button @click="handleTabClick('board')"
                    class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3"
                    :class="activeTab === 'board' ? 'bg-white/20 shadow-md font-bold' : 'hover:bg-white/10 text-white/80'">
                    <span>üìã</span> Êé≤Á§∫Êùø
                </button>
                <button @click="handleTabClick('rooms')"
                    class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3 relative"
                    :class="activeTab === 'rooms' ? 'bg-white/20 shadow-md font-bold' : 'hover:bg-white/10 text-white/80'">
                    <span>üè†</span> ÈÉ®Â±ã
                    <span v-if="currentRoom"
                        class="absolute right-4 w-2.5 h-2.5 bg-green-400 rounded-full animate-pulse border border-white"></span>
                </button>
                <button @click="handleTabClick('profile')"
                    class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3"
                    :class="activeTab === 'profile' ? 'bg-white/20 shadow-md font-bold' : 'hover:bg-white/10 text-white/80'">
                    <span>üë§</span> „Éó„É≠„Éï„Ç£„Éº„É´
                </button>
            </nav>
            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="flex items-center gap-3 cursor-pointer" @click="activeTab = 'profile'">
                    <img v-if="myProfile.icon" :src="myProfile.icon"
                        class="w-10 h-10 rounded-full object-cover border-2 border-white/50">
                    <div v-else
                        class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold border-2 border-white/50"
                        :class="myProfile.color">{{ myProfile.name.slice(0,1) }}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm truncate">{{ myProfile.name }}</div>
                        <div class="text-xs text-white/70 truncate">ID: {{ myUserId ? myUserId.slice(0,6) : '...' }}...
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- „É°„Ç§„É≥„Ç®„É™„Ç¢ -->
        <div class="flex-1 flex flex-col relative overflow-hidden bg-gray-50 min-w-0">
            <!-- „Éò„ÉÉ„ÉÄ„Éº („Çπ„Éû„Éõ) -->
            <header
                class="text-white p-4 shadow-md z-10 flex justify-between items-center shrink-0 transition-colors duration-300 relative"
                :class="theme.header">
                <h1 class="text-lg font-bold truncate flex items-center flex-1 mr-2">
                    <button v-if="activeTab === 'rooms' && currentRoom" @click="leaveRoom"
                        class="mr-2 bg-black/20 px-3 py-1 rounded-full text-xs flex items-center">‚Üê ÈÄÄÂá∫</button>
                    <span v-if="activeTab === 'board'">„Åø„Çì„Å™„ÅÆÊé≤Á§∫Êùø</span>
                    <span v-else-if="activeTab === 'profile'">„Éó„É≠„Éï„Ç£„Éº„É´</span>
                    <span v-else-if="activeTab === 'rooms'">{{ currentRoom ? getRoomName(currentRoom) : 'ÈÉ®Â±ã„ÇíÈÅ∏Êäû'
                        }}</span>
                </h1>
                <div class="flex items-center gap-2">
                    <button v-if="activeTab === 'rooms' && currentRoom" @click="openCurrentRoomMembers"
                        class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                        {{ roomMembers.length }}‰∫∫
                    </button>
                </div>
            </header>

            <!-- ÈÄöÁü• -->
            <transition name="notification">
                <div v-if="notification.visible"
                    class="absolute top-20 left-0 right-0 mx-auto w-max max-w-[90%] z-50 px-4 py-2 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 pointer-events-none"
                    :class="notification.bg">
                    <span>{{ notification.icon }}</span>
                    <span class="truncate max-w-[200px]">{{ notification.message }}</span>
                </div>
            </transition>

            <!-- „Çµ„Éº„Éê„ÉºË®∫Êñ≠ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
            <div v-if="serverStatus.length > 0"
                class="absolute top-16 left-0 right-0 mx-4 z-40 flex flex-col gap-2 animate-fade-in-up">
                <div v-for="err in serverStatus" :key="err"
                    class="bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-start text-sm border-2 border-white">
                    <span class="text-xl mr-2">‚ö†Ô∏è</span>
                    <div class="flex-1">
                        <p class="font-bold">{{ err.title }}</p>
                        <p class="text-xs opacity-90 mt-1">{{ err.desc }}</p>
                    </div>
                </div>
            </div>

            <!-- Êé•Á∂ö„Ç®„É©„ÉºË°®Á§∫ („Çµ„Éº„Éê„ÉºËá™‰ΩìËêΩ„Å°„Å¶„ÇãÊôÇ) -->
            <div v-if="connectionError"
                class="absolute top-0 left-0 w-full h-full flex items-center justify-center bg-white/90 z-50 p-6 text-center">
                <div>
                    <div class="text-4xl mb-4">üîå</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        PocketBase„Çµ„Éº„Éê„Éº ({{ PB_URL }}) „Åå<br>Ëµ∑Âãï„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÄÅÊé•Á∂ö„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                    </p>
                    <button @click="retryConnection"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-indigo-700 transition">ÂÜçË©¶Ë°å</button>
                </div>
            </div>

            <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="flex-1 overflow-hidden relative">
                <transition name="page" mode="out-in">

                    <!-- 1. Êé≤Á§∫Êùø -->
                    <div v-if="activeTab === 'board'" key="board" class="h-full flex flex-col w-full">
                        <div class="p-2 text-center text-xs font-bold border-b border-gray-100"
                            :class="[theme.light, theme.text]">
                            „Åì„Åì„ÅØÂÖ®‰ΩìÊé≤Á§∫Êùø„Åß„Åô (PocketBaseÁ®ºÂÉç‰∏≠)
                        </div>
                        <div ref="boardContainer" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20 md:pb-4">
                            <div v-if="boardMessages.length === 0" class="text-center text-gray-400 text-sm py-10">
                                „Åæ„Å†ÊäïÁ®ø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>
                            <div v-for="msg in boardMessages" :key="msg.id"
                                class="flex flex-col items-start animate-fade-in-up">
                                <div class="flex items-end mb-1 ml-1 group cursor-pointer"
                                    @click="showUserProfile(msg)">
                                    <img v-if="msg.user_icon" :src="msg.user_icon"
                                        class="w-8 h-8 rounded-full border object-cover mr-2">
                                    <div v-else
                                        class="w-8 h-8 rounded-full mr-2 flex items-center justify-center text-white text-xs font-bold"
                                        :class="msg.user_color">{{ msg.user_name.slice(0,1) }}</div>
                                    <span class="text-xs text-gray-600 font-bold mr-2">{{ msg.user_name }}</span>
                                    <span class="text-[10px] text-gray-400">{{ formatTime(msg.created) }}</span>
                                </div>
                                <div
                                    class="bg-white border border-gray-200 rounded-xl rounded-tl-none px-4 py-2 text-sm shadow-sm break-words max-w-[90%] ml-10">
                                    {{ msg.text }}
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-white border-t border-gray-200 absolute bottom-0 w-full md:static">
                            <form @submit.prevent="sendMessage('board')" class="flex gap-2">
                                <input v-model="newMessage" type="text" placeholder="„Å≤„Å®„Åì„Å®..."
                                    class="flex-1 bg-gray-100 rounded-full px-4 py-3 focus:outline-none focus:ring-2 text-sm"
                                    :class="`focus:ring-${theme.base}-500`">
                                <button type="submit"
                                    class="text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"
                                    :class="theme.button" :disabled="!newMessage.trim()">
                                    <span class="rotate-90 transform">‚û§</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- 2. ÈÉ®Â±ã -->
                    <div v-else-if="activeTab === 'rooms'" key="rooms" class="h-full flex flex-col w-full">
                        <div v-if="!currentRoom" class="h-full overflow-y-auto p-4 space-y-4 pb-20 md:pb-4">
                            <div class="grid gap-3 md:grid-cols-2">
                                <button v-for="room in rooms" :key="room.id" @click="enterRoom(room.id)"
                                    class="relative p-4 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all text-left flex items-center group h-full">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 text-xl"
                                        :class="[theme.light, theme.text]">{{ room.icon }}</div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <div class="font-bold text-gray-800">{{ room.name }}</div>
                                            <div class="text-xs font-bold px-2 py-1 rounded-full"
                                                :class="getRoomCount(room.id) >= 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'">
                                                {{ getRoomCount(room.id) }}/5
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">{{ room.desc }}</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <div v-else class="h-full flex flex-col relative">
                            <div ref="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20 md:pb-4">
                                <div v-if="roomMessages.length === 0" class="text-center text-gray-400 text-sm py-10">
                                    ‰∏ÄÁï™‰πó„Çä„Åß„ÅôÔºÅ</div>
                                <div v-for="msg in roomMessages" :key="msg.id" class="flex flex-col"
                                    :class="msg.user_id === myUserId ? 'items-end' : 'items-start'">
                                    <div v-if="msg.user_id !== myUserId"
                                        class="flex items-end mb-1 ml-1 group cursor-pointer"
                                        @click="showUserProfile(msg)">
                                        <img v-if="msg.user_icon" :src="msg.user_icon"
                                            class="w-8 h-8 rounded-full border object-cover mr-2">
                                        <div v-else
                                            class="w-8 h-8 rounded-full mr-2 flex items-center justify-center text-white text-xs font-bold"
                                            :class="msg.user_color">{{ msg.user_name.slice(0,1) }}</div>
                                        <span class="text-[10px] text-gray-500">{{ msg.user_name }}</span>
                                    </div>
                                    <div class="max-w-[80%] rounded-2xl px-4 py-2 text-sm shadow-sm break-words"
                                        :class="[msg.user_id === myUserId ? (msg.user_color || theme.header) + ' text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none ml-10']">
                                        {{ msg.text }}
                                    </div>
                                    <span class="text-[10px] text-gray-400 mt-1 mx-1"
                                        :class="msg.user_id !== myUserId ? 'ml-10' : ''">{{ formatTime(msg.created)
                                        }}</span>
                                </div>
                            </div>
                            <div class="p-3 bg-white border-t border-gray-200 absolute bottom-0 w-full md:static">
                                <form @submit.prevent="sendMessage('room')" class="flex gap-2">
                                    <input v-model="newMessage" type="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..."
                                        class="flex-1 bg-gray-100 rounded-full px-4 py-3 focus:outline-none focus:ring-2 text-sm"
                                        :class="`focus:ring-${theme.base}-500`">
                                    <button type="submit"
                                        class="text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"
                                        :class="theme.button" :disabled="!newMessage.trim()">
                                        <span class="rotate-90 transform">‚û§</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 3. „Éó„É≠„Éï„Ç£„Éº„É´ -->
                    <div v-else-if="activeTab === 'profile'" key="profile"
                        class="h-full overflow-y-auto p-6 pb-20 w-full md:pb-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 text-center">
                            <div class="relative w-24 h-24 mx-auto mb-4 group">
                                <img v-if="myProfile.icon" :src="myProfile.icon"
                                    class="w-full h-full rounded-full object-cover border-4 border-white shadow-md">
                                <div v-else
                                    class="w-full h-full rounded-full flex items-center justify-center text-white text-4xl font-bold shadow-md"
                                    :class="myProfile.color">{{ myProfile.name.slice(0,1) || '?' }}</div>
                                <label
                                    class="absolute bottom-0 right-0 bg-gray-800 text-white p-2 rounded-full cursor-pointer hover:bg-gray-700 shadow-lg active:scale-90 transition-transform">
                                    <span>üì∑</span>
                                    <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
                                </label>
                            </div>
                            <p class="text-xs text-gray-400 mb-4">ID: {{ myUserId }}</p>
                            <div class="space-y-4 text-left">
                                <div><label class="text-xs font-bold text-gray-500">ÂêçÂâç</label><input
                                        v-model="myProfile.name" type="text"
                                        class="w-full bg-gray-100 rounded-lg px-3 py-2 mt-1"></div>
                                <div><label class="text-xs font-bold text-gray-500">‰∏ÄË®Ä</label><textarea
                                        v-model="myProfile.bio"
                                        class="w-full bg-gray-100 rounded-lg px-3 py-2 mt-1"></textarea></div>

                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">ÈÄöÁü•Ë®≠ÂÆö</label>
                                    <div class="space-y-2 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center"><span class="text-sm text-gray-600">ÂÖ•ÂÆ§ÈÄöÁü•
                                                    (üëã)</span></div>
                                            <div
                                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                <input type="checkbox" name="toggle" id="toggle-entry"
                                                    v-model="myProfile.settings.entry"
                                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" />
                                                <label for="toggle-entry"
                                                    class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex flex-col"><span class="text-sm text-gray-600">„É°„ÉÉ„Çª„Éº„Ç∏ÈÄöÁü•
                                                    (üí¨)</span><span
                                                    class="text-[10px] text-gray-400">ON„Å´„Åô„Çã„Å®„Éñ„É©„Ç¶„Ç∂ÈÄöÁü•„ÅÆË®±ÂèØ„ÇíÊ±Ç„ÇÅ„Åæ„Åô</span></div>
                                            <div
                                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                <input type="checkbox" name="toggle" id="toggle-msg"
                                                    v-model="myProfile.settings.message"
                                                    @change="requestNotificationPermission"
                                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" />
                                                <label for="toggle-msg"
                                                    class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div><label class="text-xs font-bold text-gray-500">„ÉÜ„Éº„Éû„Ç´„É©„Éº</label>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <button v-for="c in colors" :key="c.base" @click="myProfile.color = c.main"
                                            class="w-8 h-8 rounded-full border-2"
                                            :class="[c.main, myProfile.color === c.main ? 'border-gray-800 scale-110' : 'border-transparent']"></button>
                                    </div>
                                </div>
                                <button @click="saveProfile"
                                    class="w-full text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-all"
                                    :class="theme.button">‰øùÂ≠ò„Åô„Çã</button>

                                <!-- ÁÆ°ÁêÜËÄÖÁî®„Çª„ÇØ„Ç∑„Éß„É≥ -->
                                <div v-if="myUserId === ADMIN_UID"
                                    class="mt-8 pt-6 border-t border-gray-200 animate-fade-in-up">
                                    <h3
                                        class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                        <span>üëë</span> ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº
                                    </h3>
                                    <div
                                        class="mb-3 flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200">
                                        <span class="text-sm text-gray-600 font-bold">Kick„Éú„Çø„É≥„ÇíË°®Á§∫</span>
                                        <div
                                            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="toggle" id="toggle-admin" v-model="adminMode"
                                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" />
                                            <label for="toggle-admin"
                                                class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                        </div>
                                    </div>
                                </div>

                                <!-- IDË°®Á§∫ (ÂÖ®Âì°„Å´Ë°®Á§∫) -->
                                <div class="mt-8 pt-6 border-t border-gray-200">
                                    <p class="text-[10px] text-gray-400 text-center mb-1">Your ID (Tap to copy)</p>
                                    <div class="bg-gray-100 text-gray-500 p-2 rounded text-[10px] font-mono text-center break-all cursor-pointer hover:bg-gray-200 transition-colors"
                                        @click="copyUid">
                                        {{ myUserId }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </transition>
            </div>

            <!-- „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„É¢„Éº„ÉÄ„É´ -->
            <transition name="fade">
                <div v-if="selectedUser"
                    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
                    @click="selectedUser = null">
                    <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center" @click.stop>
                        <div class="w-24 h-24 mx-auto mb-4">
                            <img v-if="selectedUser.user_icon" :src="selectedUser.user_icon"
                                class="w-full h-full rounded-full object-cover border-4 border-white shadow-md">
                            <div v-else
                                class="w-full h-full rounded-full flex items-center justify-center text-white text-4xl font-bold shadow-md"
                                :class="selectedUser.user_color">{{ selectedUser.user_name.slice(0,1) }}</div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">{{ selectedUser.user_name }}</h3>
                        <p class="text-sm text-gray-600 bg-gray-100 p-3 rounded-lg mb-4">{{ selectedUser.user_bio ||
                            '‰∏ÄË®Ä„Å™„Åó' }}</p>
                        <button v-if="selectedUser.user_id !== myUserId" @click="toggleFollow(selectedUser.user_id)"
                            class="w-full py-2 rounded-lg font-bold text-sm border transition-colors"
                            :class="isFollowing(selectedUser.user_id) ? 'bg-gray-100 text-gray-500 border-gray-300' : theme.button + ' text-white'">
                            {{ isFollowing(selectedUser.user_id) ? '„Éï„Ç©„É≠„Éº‰∏≠' : '„Éï„Ç©„É≠„Éº„Åô„Çã' }}
                        </button>
                    </div>
                </div>
            </transition>

            <!-- „É°„É≥„Éê„Éº„É™„Çπ„Éà„É¢„Éº„ÉÄ„É´ -->
            <transition name="fade">
                <div v-if="showMemberModal"
                    class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm"
                    @click="showMemberModal = false">
                    <div class="bg-white w-full sm:max-w-md h-[60vh] rounded-t-2xl sm:rounded-2xl flex flex-col"
                        @click.stop>
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold">„É°„É≥„Éê„Éº„É™„Çπ„Éà ({{ roomMembers.length }}‰∫∫)</h3>
                            <button @click="showMemberModal = false" class="text-gray-400">‚úï</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-2">
                            <div v-for="m in roomMembers" :key="m.id"
                                class="flex items-center p-2 hover:bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3 shrink-0"
                                    :class="m.user_color">{{ m.user_name.slice(0,1) }}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold truncate">{{ m.user_name }}</div>
                                    <div class="text-xs text-gray-500 truncate">{{ m.user_bio }}</div>
                                </div>
                                <span v-if="isFollowing(m.user_id)"
                                    class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">„Éï„Ç©„É≠„Éº‰∏≠</span>

                                <!-- Kick„Éú„Çø„É≥ -->
                                <button v-if="myUserId === ADMIN_UID && adminMode && m.user_id !== myUserId"
                                    @click.stop="kickUser(m)"
                                    class="ml-2 bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 transition">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- „Éú„Éà„É†„Éä„Éì („Çπ„Éû„Éõ) -->
            <nav
                class="bg-white border-t border-gray-200 shrink-0 safe-bottom md:hidden h-16 flex justify-around items-center">
                <button @click="handleTabClick('board')"
                    class="flex flex-col items-center text-xs font-medium transition-colors"
                    :class="activeTab === 'board' ? theme.text : 'text-gray-400'">
                    <span class="text-xl mb-1">üìã</span> Êé≤Á§∫Êùø
                </button>
                <button @click="handleTabClick('rooms')"
                    class="flex flex-col items-center text-xs font-medium transition-colors relative"
                    :class="activeTab === 'rooms' ? theme.text : 'text-gray-400'">
                    <span class="text-xl mb-1">üè†</span> ÈÉ®Â±ã
                    <span v-if="currentRoom" class="absolute top-1 right-3 w-2 h-2 bg-green-500 rounded-full"></span>
                </button>
                <button @click="handleTabClick('profile')"
                    class="flex-1 flex flex-col items-center text-xs font-medium transition-colors"
                    :class="activeTab === 'profile' ? theme.text : 'text-gray-400'">
                    <span class="text-xl mb-1">üë§</span> Ë®≠ÂÆö
                </button>
            </nav>

        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed, nextTick } = Vue;

        // ‚òÖ PocketBase„ÅÆURL (Cloudflare Tunnel„ÅÆURL)
        const PB_URL = 'https://policies-ave-violin-comic.trycloudflare.com';
        const ADMIN_UID = 'eIECgBKO44OtooVI040NtYXpxS73'; // ÁÆ°ÁêÜËÄÖID

        const pb = new PocketBase(PB_URL);
        pb.autoCancellation(false);

        createApp({
            setup() {
                // --- State ---
                const activeTab = ref('board');
                const currentRoom = ref(null);
                const myUserId = ref('');
                const myProfile = ref({ name: 'ÂêçÁÑ°„Åó', color: 'bg-indigo-600', icon: '', bio: '', settings: { entry: false, message: false } });

                const boardMessages = ref([]);
                const roomMessages = ref([]);
                const roomMembers = ref([]);
                const roomCounts = ref({});
                const follows = ref([]);

                const newMessage = ref("");
                const messagesContainer = ref(null);
                const boardContainer = ref(null);

                const selectedUser = ref(null);
                const showMemberModal = ref(false);
                const notification = ref({ visible: false, message: '', icon: '', bg: '' });
                const connectionError = ref(false);
                const serverStatus = ref([]);
                const isSaving = ref(false);

                // ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ„Çπ„Ç§„ÉÉ„ÉÅ
                const adminMode = ref(false);

                // --- Constants ---
                const rooms = [
                    { id: 'anime', name: '„Ç¢„Éã„É°ÈÉ®Â±ã', desc: '‰ªäÊúü„Ç¢„Éã„É°„ÇÑÂêç‰Ωú„Å´„Å§„ÅÑ„Å¶', icon: 'üì∫' },
                    { id: 'game', name: '„Ç≤„Éº„É†ÈÉ®Â±ã', desc: 'Êñ∞‰Ωú„Åã„Çâ„É¨„Éà„É≠„Ç≤„Éº„Åæ„Åß', icon: 'üéÆ' },
                    { id: 'seiyu', name: 'Â£∞ÂÑ™ÈÉ®Â±ã', desc: 'Êé®„Åó„ÅÆÂ£∞ÂÑ™„Åï„ÇìË™û„Çä', icon: 'üéôÔ∏è' },
                    { id: 'movie', name: 'Êò†ÁîªÈÉ®Â±ã', desc: 'Êñ∞‰Ωú„ÉªÊóß‰Ωú„Éª„Çµ„Éñ„Çπ„ÇØÊÑüÊÉ≥', icon: 'üé¨' },
                    { id: 'manga', name: '„Éû„É≥„Ç¨ÈÉ®Â±ã', desc: 'ÈÄ£Ëºâ‰∏≠„ÉªÂÆåÁµê‰Ωú„ÅÆÊÑüÊÉ≥', icon: 'üìö' },
                    { id: 'vtuber', name: 'V„ÉªÈÖç‰ø°ËÄÖ', desc: 'VTuber„ÇÑÂÆüÊ≥ÅËÄÖ„ÅÆË©±', icon: 'üíª' }
                ];

                const colors = [
                    { main: 'bg-indigo-600', dark: 'bg-indigo-900', light: 'bg-indigo-50', text: 'text-indigo-600', button: 'bg-indigo-600', header: 'bg-indigo-600', base: 'indigo' },
                    { main: 'bg-red-500', dark: 'bg-red-900', light: 'bg-red-50', text: 'text-red-500', button: 'bg-red-500', header: 'bg-red-500', base: 'red' },
                    { main: 'bg-green-500', dark: 'bg-green-900', light: 'bg-green-50', text: 'text-green-500', button: 'bg-green-500', header: 'bg-green-500', base: 'green' },
                    { main: 'bg-blue-500', dark: 'bg-blue-900', light: 'bg-blue-50', text: 'text-blue-500', button: 'bg-blue-500', header: 'bg-blue-500', base: 'blue' },
                    { main: 'bg-yellow-500', dark: 'bg-yellow-900', light: 'bg-yellow-50', text: 'text-yellow-600', button: 'bg-yellow-500', header: 'bg-yellow-500', base: 'yellow' },
                    { main: 'bg-purple-500', dark: 'bg-purple-900', light: 'bg-purple-50', text: 'text-purple-500', button: 'bg-purple-500', header: 'bg-purple-500', base: 'purple' },
                    { main: 'bg-pink-500', dark: 'bg-pink-900', light: 'bg-pink-50', text: 'text-pink-500', button: 'bg-pink-500', header: 'bg-pink-500', base: 'pink' },
                    { main: 'bg-gray-600', dark: 'bg-gray-900', light: 'bg-gray-100', text: 'text-gray-600', button: 'bg-gray-600', header: 'bg-gray-600', base: 'gray' },
                ];

                const theme = computed(() => colors.find(c => c.main === myProfile.value.color) || colors[0]);

                // --- Authentication ---
                const initAuth = async () => {
                    try {
                        await pb.health.check();
                        connectionError.value = false;
                    } catch (e) {
                        console.error("Server Check Error:", e);
                        connectionError.value = true;
                        return;
                    }

                    await checkCollections();

                    let storedId = localStorage.getItem('paka_uid');
                    let storedPass = localStorage.getItem('paka_pass');
                    let email = localStorage.getItem('paka_email');

                    if (!storedId || !email || !storedPass) {
                        const randomStr = Math.random().toString(36).slice(-8);
                        email = `paka_${randomStr}@example.com`;
                        storedPass = `pass_${randomStr}`;
                        const username = `user_${randomStr}`;
                        try {
                            await pb.collection('users').create({
                                username: username,
                                email: email,
                                emailVisibility: true,
                                password: storedPass,
                                passwordConfirm: storedPass,
                                name: 'ÂêçÁÑ°„Åó',
                                color: 'bg-indigo-600'
                            });
                        } catch (err) { console.error("Create Error:", err); }
                    }

                    try {
                        await pb.collection('users').authWithPassword(email, storedPass);

                        localStorage.setItem('paka_uid', pb.authStore.model.id);
                        localStorage.setItem('paka_pass', storedPass);
                        localStorage.setItem('paka_email', email);

                        myUserId.value = pb.authStore.model.id;
                        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„Éû„Éº„Ç∏
                        const userRecord = await pb.collection('users').getOne(myUserId.value);
                        myProfile.value = {
                            name: userRecord.name || 'ÂêçÁÑ°„Åó',
                            color: userRecord.color || 'bg-indigo-600',
                            bio: userRecord.bio || '',
                            icon: userRecord.icon_base64 || '',
                            // Ë®≠ÂÆö„ÇÇDB„Åã„ÇâË™≠„ÅøËæº„Åø„Åü„ÅÑ„Åå‰ªäÂõû„ÅØÁ∞°ÊòìÁöÑ„Å´
                            settings: { entry: false, message: false }
                        };

                        loadBoardMessages();
                        loadFollows();
                        subscribeRealtime();
                        updateRoomCounts();

                    } catch (err) {
                        console.error("Auth Error:", err);
                        // ÂÜç„É≠„Ç∞„Ç§„É≥Â§±ÊïóÊôÇ„ÅØ„Çπ„Éà„É¨„Éº„Ç∏„ÇØ„É™„Ç¢„Åó„Å¶„É™„É≠„Éº„Éâ„Åï„Åõ„ÇãÁ≠â„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å„Å†„Åå‰ªäÂõû„ÅØÁúÅÁï•
                    }
                };

                const checkCollections = async () => {
                    serverStatus.value = [];
                    const checks = ['messages', 'members', 'follows'];
                    for (const col of checks) {
                        try {
                            await pb.collection(col).getList(1, 1);
                        } catch (e) {
                            if (e.status === 404) {
                                serverStatus.value.push({ title: `${col} „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`, desc: `PocketBaseÁÆ°ÁêÜÁîªÈù¢„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ` });
                            } else if (e.status === 403) {
                                serverStatus.value.push({ title: `${col} „ÅÆÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`, desc: `API Rules„ÇíUnlock„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ` });
                            }
                        }
                    }
                };

                const retryConnection = () => {
                    connectionError.value = false;
                    serverStatus.value = [];
                    initAuth();
                };

                // --- Data Loading & Realtime ---
                // (ÁúÅÁï•„Åõ„ÅöË®òËø∞)
                const loadBoardMessages = async () => {
                    if (!pb.authStore.isValid) return;
                    try {
                        const result = await pb.collection('messages').getList(1, 50, { filter: 'room = ""', sort: '-created' });
                        boardMessages.value = result.items;
                    } catch (e) { console.error(e); }
                };

                const loadRoomMessages = async (roomId) => {
                    if (!pb.authStore.isValid) return;
                    try {
                        const result = await pb.collection('messages').getList(1, 50, { filter: `room = "${roomId}"`, sort: 'created' });
                        roomMessages.value = result.items;
                        nextTick(scrollToBottom);
                    } catch (e) { console.error(e); }
                };

                const loadRoomMembers = async (roomId) => {
                    if (!pb.authStore.isValid) return;
                    try {
                        const result = await pb.collection('members').getFullList({ filter: `room = "${roomId}"`, sort: '-created' });
                        roomMembers.value = result;
                    } catch (e) { console.error(e); }
                };

                const loadFollows = async () => {
                    if (!pb.authStore.isValid) return;
                    try {
                        const result = await pb.collection('follows').getFullList({ filter: `owner_id = "${myUserId.value}"` });
                        follows.value = result.map(f => f.target_id);
                    } catch (e) { console.error(e); }
                };

                const updateRoomCounts = async () => {
                    try {
                        const result = await pb.collection('members').getFullList();
                        const counts = {};
                        result.forEach(m => { counts[m.room] = (counts[m.room] || 0) + 1; });
                        roomCounts.value = counts;
                    } catch (e) { }
                };

                const subscribeRealtime = () => {
                    pb.collection('messages').subscribe('*', function (e) {
                        if (e.action === 'create') {
                            const msg = e.record;
                            if (msg.room === '') {
                                boardMessages.value.unshift(msg);
                            } else if (msg.room === currentRoom.value) {
                                roomMessages.value.push(msg);
                                nextTick(scrollToBottom);
                            }
                        }
                    });

                    pb.collection('members').subscribe('*', function (e) {
                        if (e.action === 'create') {
                            if (e.record.room === currentRoom.value) {
                                roomMembers.value.unshift(e.record);
                                if (e.record.user_id !== myUserId.value && myProfile.value.settings.entry) {
                                    const isFollow = follows.value.includes(e.record.user_id);
                                    showNotification(`${e.record.user_name}„Åï„Çì„ÅåÂÖ•ÂÆ§„Åó„Åæ„Åó„Åü`, 'üëã', isFollow ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
                                }
                            }
                            updateRoomCounts();
                        } else if (e.action === 'delete') {
                            // Ëá™ÂàÜ„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà (Kick)
                            if (e.record.user_id === myUserId.value && currentRoom.value === e.record.room) {
                                leaveRoom();
                                alert("ÈÄÄÂÆ§„Åó„Åæ„Åó„ÅüÔºà„Åæ„Åü„ÅØÁÆ°ÁêÜËÄÖ„Å´„Çà„ÇäÈÄÄÂá∫„Åï„Åõ„Çâ„Çå„Åæ„Åó„ÅüÔºâ");
                            }

                            if (e.record.room === currentRoom.value) {
                                roomMembers.value = roomMembers.value.filter(m => m.id !== e.record.id);
                                if (e.record.user_id !== myUserId.value && myProfile.value.settings.entry) {
                                    showNotification(`${e.record.user_name}„Åï„Çì„ÅåÈÄÄÂÆ§„Åó„Åæ„Åó„Åü`, 'üö™', 'bg-gray-100 text-gray-600');
                                }
                            }
                            updateRoomCounts();
                        }
                    });
                };

                // --- Actions ---
                const sendMessage = async (target) => {
                    if (!newMessage.value.trim()) return;
                    const text = newMessage.value;
                    newMessage.value = "";
                    const room = target === 'board' ? '' : currentRoom.value;
                    try {
                        await pb.collection('messages').create({
                            text: text,
                            room: room,
                            user_id: myUserId.value,
                            user_name: myProfile.value.name,
                            user_color: myProfile.value.color,
                            user_icon: myProfile.value.icon,
                        });
                    } catch (e) { console.error(e); alert("ÈÄÅ‰ø°„Ç®„É©„Éº: " + e.message); }
                };

                const enterRoom = async (roomId) => {
                    if (currentRoom.value) await leaveRoom();
                    try {
                        const record = await pb.collection('members').create({
                            room: roomId,
                            user_id: myUserId.value,
                            user_name: myProfile.value.name,
                            user_color: myProfile.value.color,
                            user_icon: myProfile.value.icon,
                            user_bio: myProfile.value.bio
                        });
                        sessionStorage.setItem('member_record_id', record.id);
                        currentRoom.value = roomId;
                        activeTab.value = 'rooms';
                        loadRoomMessages(roomId);
                        loadRoomMembers(roomId);
                    } catch (e) { console.error(e); alert("ÂÖ•ÂÆ§„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: " + e.message); }
                };

                const leaveRoom = async () => {
                    if (!currentRoom.value) return;
                    const recordId = sessionStorage.getItem('member_record_id');
                    if (recordId) {
                        try { await pb.collection('members').delete(recordId); } catch (e) { }
                    }
                    currentRoom.value = null;
                    roomMessages.value = [];
                    roomMembers.value = [];
                };

                const saveProfile = async () => {
                    isSaving.value = true;
                    try {
                        await pb.collection('users').update(myUserId.value, {
                            name: myProfile.value.name,
                            color: myProfile.value.color,
                            bio: myProfile.value.bio,
                            icon_base64: myProfile.value.icon
                        });
                        alert("‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
                    } catch (e) { console.error(e); alert("‰øùÂ≠ò„Ç®„É©„Éº: " + e.message); }
                    finally { isSaving.value = false; }
                };

                const toggleFollow = async (targetId) => {
                    const isFollowing = follows.value.includes(targetId);
                    try {
                        if (isFollowing) {
                            const list = await pb.collection('follows').getList(1, 1, { filter: `owner_id = "${myUserId.value}" && target_id = "${targetId}"` });
                            if (list.items.length > 0) await pb.collection('follows').delete(list.items[0].id);
                            follows.value = follows.value.filter(id => id !== targetId);
                        } else {
                            await pb.collection('follows').create({ owner_id: myUserId.value, target_id: targetId });
                            follows.value.push(targetId);
                        }
                    } catch (e) { console.error(e); alert("„Éï„Ç©„É≠„ÉºÊìç‰Ωú„Ç®„É©„Éº"); }
                };

                const kickUser = async (member) => {
                    if (!confirm(`${member.user_name}„Åï„Çì„ÇíÂº∑Âà∂ÈÄÄÂÆ§„Åï„Åõ„Åæ„Åô„ÅãÔºü`)) return;
                    try {
                        // members„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâË©≤ÂΩì„É¨„Ç≥„Éº„Éâ„ÇíÂâäÈô§„Åô„Çã„Å†„Åë
                        await pb.collection('members').delete(member.id);
                        alert("ÊéíÈô§„Åó„Åæ„Åó„Åü");
                    } catch (e) {
                        console.error(e);
                        alert("ÊéíÈô§Â§±Êïó: " + e.message);
                    }
                };

                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => { myProfile.value.icon = ev.target.result; };
                    reader.readAsDataURL(file);
                };

                // UI Helpers
                const handleTabClick = (tab) => {
                    if (activeTab.value === 'rooms' && tab === 'rooms' && currentRoom.value) {
                        leaveRoom();
                    } else {
                        activeTab.value = tab;
                    }
                };
                const showUserProfile = (user) => { selectedUser.value = user; };
                const openCurrentRoomMembers = () => { showMemberModal.value = true; };
                const formatTime = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                };
                const getRoomName = (id) => rooms.find(r => r.id === id)?.name;
                const getRoomCount = (id) => roomCounts.value[id] || 0;
                const isFollowing = (uid) => follows.value.includes(uid);
                const scrollToBottom = () => { if (messagesContainer.value) messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight; };
                const showNotification = (msg, icon, bg) => {
                    notification.value = { visible: true, message: msg, icon, bg };
                    setTimeout(() => notification.value.visible = false, 3000);
                };
                const copyUid = () => {
                    navigator.clipboard.writeText(myUserId.value).then(() => alert("ID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"));
                };
                const requestNotificationPermission = () => {
                    if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
                };

                onMounted(initAuth);

                window.addEventListener('beforeunload', () => { leaveRoom(); });

                return {
                    activeTab, currentRoom, boardMessages, roomMessages, roomMembers,
                    newMessage, messagesContainer, boardContainer,
                    myProfile, colors, isSaving,
                    selectedUser, showMemberModal, notification, connectionError, serverStatus,
                    rooms, theme, myUserId, PB_URL, ADMIN_UID, adminMode, // Â§âÊï∞
                    handleTabClick, enterRoom, leaveRoom, sendMessage, saveProfile, handleImageUpload,
                    showUserProfile, formatTime, getRoomName, getRoomCount, openCurrentRoomMembers,
                    toggleFollow, isFollowing, retryConnection, copyUid, kickUser, requestNotificationPermission
                };
            }
        }).mount('#app');
    </script>
</body>

</html>